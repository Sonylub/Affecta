{% extends "base.html" %}

{% block title %}Настройка отчёта - Affecta{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-8 transition-colors duration-200">
        <h1 class="text-3xl font-bold text-gray-800 dark:text-gray-100 mb-6">Настройка отчёта</h1>
        
        <form id="report-settings-form" class="space-y-8">
            <!-- Выбор периода -->
            <div class="section">
                <h2 class="text-xl font-semibold text-gray-800 dark:text-gray-200 mb-4">Период отчёта</h2>
                <div class="space-y-4">
                    <div class="flex flex-wrap gap-3">
                        <label class="flex items-center text-gray-700 dark:text-gray-300">
                            <input type="radio" name="period_type" value="preset" checked class="mr-2">
                            <span class="text-gray-700 dark:text-gray-300">Предустановленный период</span>
                        </label>
                        <label class="flex items-center text-gray-700 dark:text-gray-300">
                            <input type="radio" name="period_type" value="custom" class="mr-2">
                            <span class="text-gray-700 dark:text-gray-300">Произвольный диапазон</span>
                        </label>
                    </div>
                    
                    <div id="preset-periods" class="flex flex-wrap gap-3">
                        <button type="button" data-days="7" class="period-btn bg-indigo-600 dark:bg-indigo-500 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-indigo-700 dark:hover:bg-indigo-600 transition">
                            7 дней
                        </button>
                        <button type="button" data-days="30" class="period-btn bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-300 dark:hover:bg-gray-600 transition">
                            Месяц
                        </button>
                        <button type="button" data-days="180" class="period-btn bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-300 dark:hover:bg-gray-600 transition">
                            6 месяцев
                        </button>
                        <button type="button" data-days="365" class="period-btn bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-300 dark:hover:bg-gray-600 transition">
                            Год
                        </button>
                    </div>
                    
                    <div id="custom-period" class="hidden space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Начальная дата</label>
                                <input type="date" id="custom-start-date" name="custom_start_date" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-2 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Конечная дата</label>
                                <input type="date" id="custom-end-date" name="custom_end_date" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-2 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                            </div>
                        </div>
                    </div>
                    
                    <div id="period-display" class="text-sm text-gray-600 dark:text-gray-400 mt-2">
                        <!-- Отображается выбранный период -->
                    </div>
                </div>
            </div>
            
            <!-- Выбор разделов -->
            <div class="section">
                <h2 class="text-xl font-semibold text-gray-800 dark:text-gray-200 mb-4">Разделы отчёта</h2>
                <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Выберите разделы, которые нужно включить в отчёт:</p>
                
                <div class="space-y-3">
                    <label class="flex items-center p-3 bg-gray-50 dark:bg-gray-700 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-600 cursor-pointer transition-colors">
                        <input type="checkbox" name="sections" value="phase_history" checked class="mr-3 w-4 h-4 text-indigo-600">
                        <div class="flex-1">
                            <span class="font-medium text-gray-800 dark:text-gray-200">История фаз (график)</span>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Визуализация изменения фаз за выбранный период</p>
                        </div>
                    </label>
                    
                    <label class="flex items-center p-3 bg-gray-50 dark:bg-gray-700 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-600 cursor-pointer transition-colors">
                        <input type="checkbox" name="sections" value="sleep_stats" checked class="mr-3 w-4 h-4 text-indigo-600">
                        <div class="flex-1">
                            <span class="font-medium text-gray-800 dark:text-gray-200">Агрегированная статистика сна</span>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Среднее, минимум, максимум часов сна, качество сна, график</p>
                        </div>
                    </label>
                    
                    <label class="flex items-center p-3 bg-gray-50 dark:bg-gray-700 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-600 cursor-pointer transition-colors">
                        <input type="checkbox" name="sections" value="states_chart" checked class="mr-3 w-4 h-4 text-indigo-600">
                        <div class="flex-1">
                            <span class="font-medium text-gray-800 dark:text-gray-200">График состояний</span>
                            <p class="text-sm text-gray-600 dark:text-gray-400">График настроения, энергии, раздражительности и тревоги</p>
                        </div>
                    </label>
                    
                    <label class="flex items-center p-3 bg-gray-50 dark:bg-gray-700 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-600 cursor-pointer transition-colors">
                        <input type="checkbox" name="sections" value="notes" checked class="mr-3 w-4 h-4 text-indigo-600">
                        <div class="flex-1">
                            <span class="font-medium text-gray-800 dark:text-gray-200">Текстовые заметки</span>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Заметки за выбранный период в хронологическом порядке</p>
                        </div>
                    </label>
                </div>
            </div>
            
            <!-- Комментарий к отчёту -->
            <div class="section">
                <h2 class="text-xl font-semibold text-gray-800 dark:text-gray-200 mb-4">Комментарий к отчёту (необязательно)</h2>
                <textarea 
                    id="report-comment" 
                    name="comment" 
                    rows="4" 
                    placeholder="Введите комментарий, который будет добавлен в начало отчёта..."
                    class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-2 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder-gray-500 dark:placeholder-gray-400 focus:ring-2 focus:ring-indigo-500 dark:focus:ring-indigo-400 focus:border-indigo-500 dark:focus:border-indigo-400"
                ></textarea>
            </div>
            
            <!-- Кнопки действий -->
            <div class="flex justify-end gap-4 pt-6 border-t border-gray-200 dark:border-gray-700">
                <a href="{{ url_for('main.dashboard') }}" class="px-6 py-2 text-gray-700 dark:text-gray-300 bg-gray-200 dark:bg-gray-700 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition">
                    Отмена
                </a>
                <button type="submit" id="generate-btn" class="px-6 py-2 text-white bg-indigo-600 dark:bg-indigo-500 rounded-lg hover:bg-indigo-700 dark:hover:bg-indigo-600 transition font-medium">
                    Сформировать отчёт
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('report-settings-form');
    const periodTypeRadios = document.querySelectorAll('input[name="period_type"]');
    const presetPeriods = document.getElementById('preset-periods');
    const customPeriod = document.getElementById('custom-period');
    const periodDisplay = document.getElementById('period-display');
    const periodBtns = document.querySelectorAll('.period-btn');
    const generateBtn = document.getElementById('generate-btn');
    
    let selectedDays = 7;
    let customStartDate = null;
    let customEndDate = null;
    
    // Получение даты последней записи из сервера
    const lastEntryDateStr = {% if last_entry_date %}'{{ last_entry_date.strftime("%Y-%m-%d") }}'{% else %}null{% endif %};
    const lastEntryDate = lastEntryDateStr ? new Date(lastEntryDateStr + 'T00:00:00') : new Date();
    
    // Используем дату последней записи как максимальную дату, если она есть, иначе сегодняшнюю
    const maxDate = lastEntryDateStr || new Date().toISOString().split('T')[0];
    document.getElementById('custom-start-date').setAttribute('max', maxDate);
    document.getElementById('custom-end-date').setAttribute('max', maxDate);
    
    // Для расчета периодов используем дату последней записи вместо сегодняшней
    const today = lastEntryDateStr ? new Date(lastEntryDateStr + 'T00:00:00') : new Date();
    
    // Обработка переключения типа периода
    periodTypeRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.value === 'preset') {
                presetPeriods.classList.remove('hidden');
                customPeriod.classList.add('hidden');
                updatePeriodDisplay();
            } else {
                presetPeriods.classList.add('hidden');
                customPeriod.classList.remove('hidden');
                updatePeriodDisplay();
            }
        });
    });
    
    // Обработка выбора предустановленного периода
    periodBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            periodBtns.forEach(b => {
                b.classList.remove('bg-indigo-600', 'dark:bg-indigo-500', 'text-white');
                b.classList.add('bg-gray-200', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
            });
            this.classList.remove('bg-gray-200', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
            this.classList.add('bg-indigo-600', 'dark:bg-indigo-500', 'text-white');
            selectedDays = parseInt(this.getAttribute('data-days'));
            updatePeriodDisplay();
        });
    });
    
    // Обработка произвольного диапазона
    document.getElementById('custom-start-date').addEventListener('change', function() {
        customStartDate = this.value;
        updatePeriodDisplay();
    });
    
    document.getElementById('custom-end-date').addEventListener('change', function() {
        customEndDate = this.value;
        updatePeriodDisplay();
    });
    
    // Обновление отображения периода
    function updatePeriodDisplay() {
        if (document.querySelector('input[name="period_type"]:checked').value === 'preset') {
            const endDate = new Date(today);
            const startDate = new Date(today);
            startDate.setDate(startDate.getDate() - (selectedDays - 1));
            periodDisplay.textContent = `${formatDate(startDate)} - ${formatDate(endDate)}`;
        } else {
            if (customStartDate && customEndDate) {
                periodDisplay.textContent = `${formatDate(new Date(customStartDate))} - ${formatDate(new Date(customEndDate))}`;
            } else {
                periodDisplay.textContent = 'Выберите диапазон дат';
            }
        }
    }
    
    // Форматирование даты
    function formatDate(date) {
        return date.toLocaleDateString('ru-RU', { day: '2-digit', month: 'long', year: 'numeric' });
    }
    
    // Инициализация отображения периода
    updatePeriodDisplay();
    
    // Обработка отправки формы
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // Получение данных формы
        const periodType = document.querySelector('input[name="period_type"]:checked').value;
        let startDate, endDate;
        
        if (periodType === 'preset') {
            endDate = new Date(today);
            startDate = new Date(today);
            startDate.setDate(startDate.getDate() - (selectedDays - 1));
        } else {
            if (!customStartDate || !customEndDate) {
                alert('Выберите диапазон дат');
                return;
            }
            startDate = new Date(customStartDate);
            endDate = new Date(customEndDate);
        }
        
        // Нормализация дат (убираем время для корректного сравнения)
        startDate.setHours(0, 0, 0, 0);
        endDate.setHours(0, 0, 0, 0);
        
        // Проверка дат
        if (startDate > endDate) {
            alert('Начальная дата должна быть раньше конечной');
            return;
        }
        
        const maxAllowedDate = lastEntryDateStr ? new Date(lastEntryDateStr + 'T00:00:00') : new Date();
        maxAllowedDate.setHours(0, 0, 0, 0);
        if (startDate > maxAllowedDate || endDate > maxAllowedDate) {
            const maxDateStr = lastEntryDateStr ? new Date(lastEntryDateStr + 'T00:00:00').toLocaleDateString('ru-RU') : 'сегодня';
            alert(`Нельзя выбирать даты позже последней записи (${maxDateStr})`);
            return;
        }
        
        // Получение выбранных разделов
        const sections = {};
        document.querySelectorAll('input[name="sections"]:checked').forEach(cb => {
            sections[cb.value] = true;
        });
        
        // Проверка, что выбран хотя бы один раздел
        if (Object.keys(sections).length === 0) {
            alert('Выберите хотя бы один раздел для включения в отчёт');
            return;
        }
        
        // Получение комментария
        const comment = document.getElementById('report-comment').value.trim();
        
        // Блокировка кнопки
        generateBtn.disabled = true;
        generateBtn.textContent = 'Формирование...';
        
        try {
            // Формирование параметров запроса
            const params = new URLSearchParams({
                start_date: startDate.toISOString().split('T')[0],
                end_date: endDate.toISOString().split('T')[0],
                comment: comment || ''
            });
            
            // Добавление разделов
            Object.keys(sections).forEach(section => {
                params.append('sections', section);
            });
            
            // Запрос на генерацию PDF
            const response = await fetch(`/generate_report?${params.toString()}`);
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.message || 'Ошибка при формировании отчёта');
            }
            
            // Получение PDF
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `affecta_report_${startDate.toISOString().split('T')[0]}_${endDate.toISOString().split('T')[0]}.pdf`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            // Успешное сообщение
            alert('Отчёт успешно сформирован и загружен');
            
        } catch (error) {
            console.error('Ошибка:', error);
            alert('Ошибка при формировании отчёта: ' + error.message);
        } finally {
            generateBtn.disabled = false;
            generateBtn.textContent = 'Сформировать отчёт';
        }
    });
});
</script>
{% endblock %}

