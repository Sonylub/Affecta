{% extends "base.html" %}

{% block title %}–î–Ω–µ–≤–Ω–∏–∫ - –°—Ç–∞–±–∏–ª{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-8">
        <div>
            <h1 class="text-3xl font-bold text-gray-900 dark:text-white">
                –î–Ω–µ–≤–Ω–∏–∫ –º—ã—Å–ª–µ–π –∏ –Ω–∞–±–ª—é–¥–µ–Ω–∏–π
            </h1>
            <p class="text-gray-600 dark:text-gray-400 mt-1">
                –ó–∞–ø–∏—Å—ã–≤–∞–π—Ç–µ —Å–≤–æ–∏ –º—ã—Å–ª–∏, —á—É–≤—Å—Ç–≤–∞ –∏ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è
            </p>
        </div>
        
        <button onclick="openNewNoteModal()" 
                class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 transition-colors">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
            </svg>
            –ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å
        </button>
    </div>
    
    <!-- –§–∏–ª—å—Ç—Ä—ã -->
    <div class="bg-white dark:bg-gray-800 rounded-xl p-4 card-shadow mb-6">
        <div class="flex flex-wrap items-center gap-4">
            <div class="flex items-center space-x-2">
                <label class="text-sm font-medium text-gray-700 dark:text-gray-300">
                    –¢–∏–ø –∑–∞–ø–∏—Å–∏:
                </label>
                <select id="noteTypeFilter" onchange="filterNotes()" 
                        class="block w-32 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    <option value="">–í—Å–µ</option>
                    <option value="thought">–ú—ã—Å–ª–∏</option>
                    <option value="cbt">–ö–ü–¢</option>
                    <option value="dbt">–î–ë–¢</option>
                    <option value="act">ACT</option>
                    <option value="ipsrt">IPSRT</option>
                </select>
            </div>
            
            <div class="flex items-center space-x-2">
                <label class="text-sm font-medium text-gray-700 dark:text-gray-300">
                    –ü–µ—Ä–∏–æ–¥:
                </label>
                <select id="periodFilter" onchange="filterNotes()" 
                        class="block w-32 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    <option value="all">–í—Å–µ –≤—Ä–µ–º—è</option>
                    <option value="7">7 –¥–Ω–µ–π</option>
                    <option value="30">30 –¥–Ω–µ–π</option>
                    <option value="90">90 –¥–Ω–µ–π</option>
                </select>
            </div>
            
            <div class="flex-1">
                <input type="text" id="searchFilter" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∑–∞–ø–∏—Å—è–º..." 
                       class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                       onkeyup="filterNotes()">
            </div>
        </div>
    </div>
    
    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-white dark:bg-gray-800 p-4 rounded-xl card-shadow text-center">
            <div class="text-2xl font-bold text-blue-600 dark:text-blue-400 mb-1">
                {{ notes|length }}
            </div>
            <div class="text-sm text-gray-600 dark:text-gray-400">
                –í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π
            </div>
        </div>
        
        <div class="bg-white dark:bg-gray-800 p-4 rounded-xl card-shadow text-center">
            <div class="text-2xl font-bold text-green-600 dark:text-green-400 mb-1">
                {{ notes|selectattr('note_type', 'equalto', 'cbt')|list|length }}
            </div>
            <div class="text-sm text-gray-600 dark:text-gray-400">
                –ö–ü–¢ –∑–∞–ø–∏—Å–µ–π
            </div>
        </div>
        
        <div class="bg-white dark:bg-gray-800 p-4 rounded-xl card-shadow text-center">
            <div class="text-2xl font-bold text-purple-600 dark:text-purple-400 mb-1">
                {{ notes|selectattr('note_type', 'equalto', 'dbt')|list|length }}
            </div>
            <div class="text-sm text-gray-600 dark:text-gray-400">
                –î–ë–¢ –∑–∞–ø–∏—Å–µ–π
            </div>
        </div>
        
        <div class="bg-white dark:bg-gray-800 p-4 rounded-xl card-shadow text-center">
            <div class="text-2xl font-bold text-orange-600 dark:text-orange-400 mb-1">
                {{ notes|selectattr('note_type', 'equalto', 'thought')|list|length }}
            </div>
            <div class="text-sm text-gray-600 dark:text-gray-400">
                –ó–∞–ø–∏—Å–µ–π –º—ã—Å–ª–µ–π
            </div>
        </div>
    </div>
    
    <!-- –ó–∞–ø–∏—Å–∏ -->
    <div id="notesContainer" class="space-y-4">
        {% if notes %}
            {% for note in notes %}
            <div class="bg-white dark:bg-gray-800 rounded-xl p-6 card-shadow note-item" 
                 data-type="{{ note.note_type }}" 
                 data-date="{{ note.created_at.strftime('%Y-%m-%d') }}">
                
                <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∑–∞–ø–∏—Å–∏ -->
                <div class="flex items-start justify-between mb-4">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 rounded-full flex items-center justify-center text-white text-sm font-medium"
                             style="background-color: 
                                    {% if note.note_type == 'cbt' %}#3B82F6
                                    {% elif note.note_type == 'dbt' %}#10B981
                                    {% elif note.note_type == 'act' %}#8B5CF6
                                    {% elif note.note_type == 'ipsrt' %}#F59E0B
                                    {% else %}#6B7280{% endif %}">
                            {% if note.note_type == 'cbt' %}–ö{% endif %}
                            {% if note.note_type == 'dbt' %}–î{% endif %}
                            {% if note.note_type == 'act' %}A{% endif %}
                            {% if note.note_type == 'ipsrt' %}I{% endif %}
                            {% if note.note_type == 'thought' %}–ú{% endif %}
                        </div>
                        
                        <div>
                            <h3 class="font-semibold text-gray-900 dark:text-white">
                                {% if note.title %}
                                    {{ note.title }}
                                {% else %}
                                    {% if note.note_type == 'cbt' %}–ö–ü–¢ –∑–∞–ø–∏—Å—å{% endif %}
                                    {% if note.note_type == 'dbt' %}–î–ë–¢ –∑–∞–ø–∏—Å—å{% endif %}
                                    {% if note.note_type == 'act' %}ACT –∑–∞–ø–∏—Å—å{% endif %}
                                    {% if note.note_type == 'ipsrt' %}IPSRT –∑–∞–ø–∏—Å—å{% endif %}
                                    {% if note.note_type == 'thought' %}–ó–∞–ø–∏—Å—å –º—ã—Å–ª–µ–π{% endif %}
                                {% endif %}
                            </h3>
                            <p class="text-sm text-gray-500 dark:text-gray-400">
                                {{ note.created_at.strftime('%d.%m.%Y %H:%M') }}
                            </p>
                        </div>
                    </div>
                    
                    <div class="flex items-center space-x-2">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                               {% if note.note_type == 'cbt' %}bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300{% endif %}
                               {% if note.note_type == 'dbt' %}bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300{% endif %}
                               {% if note.note_type == 'act' %}bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-300{% endif %}
                               {% if note.note_type == 'ipsrt' %}bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300{% endif %}
                               {% if note.note_type == 'thought' %}bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300{% endif %}">
                            {% if note.note_type == 'cbt' %}–ö–ü–¢{% endif %}
                            {% if note.note_type == 'dbt' %}–î–ë–¢{% endif %}
                            {% if note.note_type == 'act' %}ACT{% endif %}
                            {% if note.note_type == 'ipsrt' %}IPSRT{% endif %}
                            {% if note.note_type == 'thought' %}–ú—ã—Å–ª–∏{% endif %}
                        </span>
                        
                        <button onclick="deleteNote({{ note.id }})" 
                                class="text-gray-400 hover:text-red-500 transition-colors">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <!-- –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ -->
                <div class="prose dark:prose-dark max-w-none">
                    {% if note.content %}
                        <p class="text-gray-700 dark:text-gray-300 mb-4">{{ note.content }}</p>
                    {% endif %}
                    
                    {% if note.situation %}
                        <div class="mb-3">
                            <h4 class="font-medium text-gray-900 dark:text-white mb-1">–°–∏—Ç—É–∞—Ü–∏—è:</h4>
                            <p class="text-sm text-gray-600 dark:text-gray-400">{{ note.situation }}</p>
                        </div>
                    {% endif %}
                    
                    {% if note.automatic_thoughts %}
                        <div class="mb-3">
                            <h4 class="font-medium text-gray-900 dark:text-white mb-1">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –º—ã—Å–ª–∏:</h4>
                            <p class="text-sm text-gray-600 dark:text-gray-400">{{ note.automatic_thoughts }}</p>
                        </div>
                    {% endif %}
                    
                    {% if note.emotions %}
                        <div class="mb-3">
                            <h4 class="font-medium text-gray-900 dark:text-white mb-1">–≠–º–æ—Ü–∏–∏:</h4>
                            <p class="text-sm text-gray-600 dark:text-gray-400">{{ note.emotions }}</p>
                        </div>
                    {% endif %}
                    
                    {% if note.cognitive_distortions %}
                        <div class="mb-3">
                            <h4 class="font-medium text-gray-900 dark:text-white mb-1">–ö–æ–≥–Ω–∏—Ç–∏–≤–Ω—ã–µ –∏—Å–∫–∞–∂–µ–Ω–∏—è:</h4>
                            <p class="text-sm text-gray-600 dark:text-gray-400">{{ note.cognitive_distortions }}</p>
                        </div>
                    {% endif %}
                    
                    {% if note.rational_response %}
                        <div class="mb-3">
                            <h4 class="font-medium text-gray-900 dark:text-white mb-1">–†–∞—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç:</h4>
                            <p class="text-sm text-gray-600 dark:text-gray-400">{{ note.rational_response }}</p>
                        </div>
                    {% endif %}
                    
                    {% if note.skill_used %}
                        <div class="mb-3">
                            <h4 class="font-medium text-gray-900 dark:text-white mb-1">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–π –Ω–∞–≤—ã–∫:</h4>
                            <p class="text-sm text-gray-600 dark:text-gray-400">{{ note.skill_used }}</p>
                            {% if note.effectiveness %}
                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                                    –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: {{ note.effectiveness }}/10
                                </p>
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        {% else %}
            <!-- –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ -->
            <div class="text-center py-12">
                <div class="text-6xl mb-4">üìù</div>
                <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-4">
                    –£ –≤–∞—Å –µ—â–µ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π
                </h3>
                <p class="text-gray-600 dark:text-gray-400 mb-6 max-w-md mx-auto">
                    –ù–∞—á–Ω–∏—Ç–µ –≤–µ—Å—Ç–∏ –¥–Ω–µ–≤–Ω–∏–∫, —á—Ç–æ–±—ã –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —Å–≤–æ–∏ –º—ã—Å–ª–∏, 
                    —á—É–≤—Å—Ç–≤–∞ –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å –≤ —Ç–µ—Ä–∞–ø–∏–∏.
                </p>
                <button onclick="openNewNoteModal()" 
                        class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-lg text-white bg-blue-600 hover:bg-blue-700 transition-colors">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                    –°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—É—é –∑–∞–ø–∏—Å—å
                </button>
            </div>
        {% endif %}
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–æ–≤–æ–π –∑–∞–ø–∏—Å–∏ -->
<div id="newNoteModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 rounded-xl p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-semibold text-gray-900 dark:text-white">
                –ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å
            </h3>
            <button onclick="closeNewNoteModal()" 
                    class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        
        <form id="newNoteForm" onsubmit="saveNewNote(event)">
            <div class="space-y-4">
                <!-- –¢–∏–ø –∑–∞–ø–∏—Å–∏ -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        –¢–∏–ø –∑–∞–ø–∏—Å–∏
                    </label>
                    <select name="note_type" onchange="updateNoteForm()" 
                            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                        <option value="thought">–ü—Ä–æ—Å—Ç–∞—è –∑–∞–ø–∏—Å—å –º—ã—Å–ª–µ–π</option>
                        <option value="cbt">–ö–ü–¢ (–¥–Ω–µ–≤–Ω–∏–∫ –º—ã—Å–ª–µ–π)</option>
                        <option value="dbt">–î–ë–¢ (–¥–Ω–µ–≤–Ω–∏–∫ –Ω–∞–≤—ã–∫–æ–≤)</option>
                        <option value="act">ACT (–æ—Å–æ–∑–Ω–∞–Ω–Ω–æ—Å—Ç—å)</option>
                        <option value="ipsrt">IPSRT (—Ä–∏—Ç–º—ã)</option>
                    </select>
                </div>
                
                <!-- –ù–∞–∑–≤–∞–Ω–∏–µ -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        –ù–∞–∑–≤–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
                    </label>
                    <input type="text" name="title" 
                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                           placeholder="–ö—Ä–∞—Ç–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏">
                </div>
                
                <!-- –û—Å–Ω–æ–≤–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ -->
                <div id="mainContent">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ
                    </label>
                    <textarea name="content" rows="6" 
                              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                              placeholder="–û–ø–∏—à–∏—Ç–µ —Å–≤–æ–∏ –º—ã—Å–ª–∏, —á—É–≤—Å—Ç–≤–∞, –Ω–∞–±–ª—é–¥–µ–Ω–∏—è..."></textarea>
                </div>
                
                <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –¥–ª—è –ö–ü–¢ -->
                <div id="cbtFields" class="hidden space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            –°–∏—Ç—É–∞—Ü–∏—è
                        </label>
                        <textarea name="situation" rows="3" 
                                  class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                                  placeholder="–û–ø–∏—à–∏—Ç–µ —Å–∏—Ç—É–∞—Ü–∏—é..."></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –º—ã—Å–ª–∏
                        </label>
                        <textarea name="automatic_thoughts" rows="3" 
                                  class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                                  placeholder="–ß—Ç–æ –≤—ã —Å–µ–±–µ —Å–∫–∞–∑–∞–ª–∏?"></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            –≠–º–æ—Ü–∏–∏ –∏ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å (0-100%)
                        </label>
                        <input type="text" name="emotions" 
                               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                               placeholder="–°—Ç—Ä–∞—Ö (70%), –ì—Ä—É—Å—Ç—å (50%)">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            –†–∞—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
                        </label>
                        <textarea name="rational_response" rows="3" 
                                  class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                                  placeholder="–ë–æ–ª–µ–µ —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–∞—è –º—ã—Å–ª—å..."></textarea>
                    </div>
                </div>
                
                <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –¥–ª—è –î–ë–¢ -->
                <div id="dbtFields" class="hidden space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–π –Ω–∞–≤—ã–∫
                        </label>
                        <select name="skill_used" 
                                class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞–≤—ã–∫...</option>
                            <option value="observe">–ù–∞–±–ª—é–¥–µ–Ω–∏–µ</option>
                            <option value="describe">–û–ø–∏—Å–∞–Ω–∏–µ</option>
                            <option value="participate">–£—á–∞—Å—Ç–∏–µ</option>
                            <option value="opposite-action">–ü—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ</option>
                            <option value="tip">TIPP</option>
                            <option value="self-soothe">–£—Å–ø–æ–∫–æ–µ–Ω–∏–µ —Å–µ–±—è</option>
                            <option value="dear-man">DEAR MAN</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å (1-10)
                        </label>
                        <input type="range" name="effectiveness" min="1" max="10" value="5" 
                               class="w-full h-2 bg-gray-200 dark:bg-gray-600 rounded-lg appearance-none cursor-pointer">
                        <div class="flex justify-between text-xs text-gray-500 dark:text-gray-400 mt-1">
                            <span>1</span>
                            <span id="effectivenessValue">5</span>
                            <span>10</span>
                        </div>
                    </div>
                </div>
                
                <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –¥–ª—è IPSRT -->
                <div id="ipsrtFields" class="hidden space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                –í—Ä–µ–º—è –ø–æ–¥—ä–µ–º–∞
                            </label>
                            <input type="time" name="wake_time" 
                                   class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                –í—Ä–µ–º—è —Å–Ω–∞
                            </label>
                            <input type="time" name="bed_time" 
                                   class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
                        </label>
                        <div class="space-y-2">
                            <label class="flex items-center">
                                <input type="checkbox" name="activities" value="work" 
                                       class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300 dark:border-gray-600 rounded">
                                <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">–†–∞–±–æ—Ç–∞/—É—á–µ–±–∞</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" name="activities" value="social" 
                                       class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300 dark:border-gray-600 rounded">
                                <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">–°–æ—Ü–∏–∞–ª—å–Ω—ã–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" name="activities" value="exercise" 
                                       class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300 dark:border-gray-600 rounded">
                                <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">–§–∏–∑–∏—á–µ—Å–∫–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- –ö–Ω–æ–ø–∫–∏ -->
            <div class="flex justify-end space-x-3 mt-6 pt-6 border-t border-gray-200 dark:border-gray-600">
                <button type="button" onclick="closeNewNoteModal()" 
                        class="px-4 py-2 border border-gray-300 dark:border-gray-600 text-sm font-medium rounded-md text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                    –û—Ç–º–µ–Ω–∞
                </button>
                <button type="submit" 
                        class="px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 transition-colors">
                    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –Ω–æ–≤–æ–π –∑–∞–ø–∏—Å–∏
    function openNewNoteModal() {
        document.getElementById('newNoteModal').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    function closeNewNoteModal() {
        document.getElementById('newNoteModal').classList.add('hidden');
        document.body.style.overflow = 'auto';
        document.getElementById('newNoteForm').reset();
        updateNoteForm();
    }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –∑–∞–ø–∏—Å–∏
    function updateNoteForm() {
        const noteType = document.querySelector('select[name="note_type"]').value;
        
        // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
        document.getElementById('cbtFields').classList.add('hidden');
        document.getElementById('dbtFields').classList.add('hidden');
        document.getElementById('ipsrtFields').classList.add('hidden');
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—ã–µ –ø–æ–ª—è
        if (noteType === 'cbt') {
            document.getElementById('cbtFields').classList.remove('hidden');
        } else if (noteType === 'dbt') {
            document.getElementById('dbtFields').classList.remove('hidden');
        } else if (noteType === 'ipsrt') {
            document.getElementById('ipsrtFields').classList.remove('hidden');
        }
    }
    
    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–æ–≤–æ–π –∑–∞–ø–∏—Å–∏
    function saveNewNote(event) {
        event.preventDefault();
        
        const formData = new FormData(event.target);
        const data = Object.fromEntries(formData.entries());
        
        // –î–ª—è –î–ë–¢ —Å–æ–±–∏—Ä–∞–µ–º —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
        if (data.note_type === 'dbt') {
            data.effectiveness = document.querySelector('input[name="effectiveness"]').value;
        }
        
        // –î–ª—è IPSRT —Å–æ–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
        if (data.note_type === 'ipsrt') {
            data.activities = formData.getAll('activities');
        }
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        fetch('/api/therapy-notes', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                alert('–ó–∞–ø–∏—Å—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!');
                closeNewNoteModal();
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞
                window.location.reload();
            } else {
                alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + result.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏');
        });
    }
    
    // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∑–∞–ø–∏—Å–µ–π
    function filterNotes() {
        const typeFilter = document.getElementById('noteTypeFilter').value;
        const periodFilter = document.getElementById('periodFilter').value;
        const searchFilter = document.getElementById('searchFilter').value.toLowerCase();
        
        const notes = document.querySelectorAll('.note-item');
        
        notes.forEach(note => {
            let show = true;
            
            // –§–∏–ª—å—Ç—Ä –ø–æ —Ç–∏–ø—É
            if (typeFilter && note.dataset.type !== typeFilter) {
                show = false;
            }
            
            // –§–∏–ª—å—Ç—Ä –ø–æ –ø–µ—Ä–∏–æ–¥—É
            if (periodFilter && periodFilter !== 'all') {
                const noteDate = new Date(note.dataset.date);
                const daysAgo = parseInt(periodFilter);
                const cutoffDate = new Date();
                cutoffDate.setDate(cutoffDate.getDate() - daysAgo);
                
                if (noteDate < cutoffDate) {
                    show = false;
                }
            }
            
            // –ü–æ–∏—Å–∫ –ø–æ —Ç–µ–∫—Å—Ç—É
            if (searchFilter) {
                const noteText = note.textContent.toLowerCase();
                if (!noteText.includes(searchFilter)) {
                    show = false;
                }
            }
            
            // –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –∑–∞–ø–∏—Å—å
            if (show) {
                note.style.display = 'block';
            } else {
                note.style.display = 'none';
            }
        });
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—É—Å—Ç–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        const visibleNotes = document.querySelectorAll('.note-item[style="display: block"], .note-item:not([style])');
        const emptyMessage = document.getElementById('emptyMessage');
        
        if (visibleNotes.length === 0) {
            if (!emptyMessage) {
                const emptyDiv = document.createElement('div');
                emptyDiv.id = 'emptyMessage';
                emptyDiv.className = 'text-center py-12';
                emptyDiv.innerHTML = `
                    <div class="text-4xl mb-2">üîç</div>
                    <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-2">
                        –ó–∞–ø–∏—Å–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã
                    </h3>
                    <p class="text-gray-600 dark:text-gray-400">
                        –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã –ø–æ–∏—Å–∫–∞
                    </p>
                `;
                document.getElementById('notesContainer').appendChild(emptyDiv);
            }
        } else if (emptyMessage) {
            emptyMessage.remove();
        }
    }
    
    // –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏
    function deleteNote(noteId) {
        if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å?')) {
            fetch(`/api/therapy-notes/${noteId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    // –£–¥–∞–ª—è–µ–º –∑–∞–ø–∏—Å—å –∏–∑ DOM
                    const noteElement = document.querySelector(`[onclick="deleteNote(${noteId})"]`).closest('.note-item');
                    noteElement.remove();
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                    window.location.reload();
                } else {
                    alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏');
            });
        }
    }
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∞–≤–∏—à
    document.addEventListener('keydown', function(e) {
        // Escape - –∑–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        if (e.key === 'Escape') {
            closeNewNoteModal();
        }
        
        // Ctrl/Cmd + N - –Ω–æ–≤–∞—è –∑–∞–ø–∏—Å—å
        if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
            e.preventDefault();
            openNewNoteModal();
        }
    });
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ
    document.getElementById('newNoteModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeNewNoteModal();
        }
    });
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    document.addEventListener('DOMContentLoaded', function() {
        updateNoteForm();
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
        const effectivenessSlider = document.querySelector('input[name="effectiveness"]');
        if (effectivenessSlider) {
            effectivenessSlider.addEventListener('input', function() {
                document.getElementById('effectivenessValue').textContent = this.value;
            });
        }
    });
</script>
{% endblock %}